<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt Doraemon Comic Generator (Gemini)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9fb0d0; --text:#eaf0ff; --accent:#4cc9f0;
      --accent2:#a78bfa; --danger:#ff6b6b; --ok:#2dd4bf;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #18264a 0%, var(--bg) 55%, #060a12 100%);
      color:var(--text);
    }
    header{
      padding:24px 18px 10px; max-width:1100px; margin:0 auto;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .sub{margin:0; color:var(--muted); font-size:13px; max-width:620px; line-height:1.35}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(76,201,240,.12);
      border:1px solid rgba(76,201,240,.3);
      color:#bff3ff; padding:6px 10px; border-radius:999px; font-size:12px;
    }
    main{max-width:1100px; margin:0 auto; padding:10px 18px 40px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(17,26,46,.86);
      border:1px solid rgba(180,200,255,.12);
      border-radius:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid rgba(180,200,255,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd b{font-size:13px}
    .card .bd{padding:14px 16px}
    label{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px}
    textarea, input[type="text"], input[type="password"], select{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(180,200,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      transition:.2s;
      font-size:13px;
    }
    textarea{min-height:92px; resize:vertical; line-height:1.45}
    textarea:focus, input:focus, select:focus{border-color: rgba(76,201,240,.55); box-shadow:0 0 0 3px rgba(76,201,240,.18)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:650px){.row{grid-template-columns:1fr}}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    button{
      border:0; cursor:pointer;
      padding:10px 14px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(76,201,240,.95), rgba(167,139,250,.95));
      color:#071018;
      font-weight:700;
      font-size:13px;
      transition:.2s;
    }
    button.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(180,200,255,.18);
      color:var(--text);
      font-weight:600;
    }
    button.danger{
      background: rgba(255,107,107,.12);
      border:1px solid rgba(255,107,107,.35);
      color:#ffd9d9;
      font-weight:700;
    }
    button:active{transform: translateY(1px)}
    .note{
      margin-top:10px; color:var(--muted); font-size:12px; line-height:1.35
    }
    .out{
      white-space:pre-wrap; word-break:break-word;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(180,200,255,.14);
      border-radius:14px;
      padding:12px;
      min-height:220px;
      font-size:13px;
      line-height:1.45;
    }
    .status{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:999px; background: rgba(159,176,208,.7)}
    .dot.ok{background: rgba(45,212,191,.95)}
    .dot.bad{background: rgba(255,107,107,.95)}
    .mini{
      font-size:11px; color:var(--muted);
    }
    .pill{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(180,200,255,.14);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      display:inline-flex;
      gap:8px; align-items:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:11px; padding:2px 6px; border-radius:8px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(180,200,255,.14);
      color:#dbe7ff;
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <div class="badge">ü™Ñ Doraemon Prompt Helper ‚Ä¢ Gemini API ‚Ä¢ 1 File</div>
    <h1>Website tƒ©nh h·ªó tr·ª£ vi·∫øt Prompt t·∫°o truy·ªán tranh Doraemon (ti·∫øng Vi·ªát)</h1>
    <p class="sub">
      Nh·∫≠p √Ω t∆∞·ªüng ‚Üí h·ªá th·ªëng t·∫°o prompt chu·∫©n m√†u s·∫Øc + panel + tho·∫°i. C√≥ <b>Character Bible c·ªë ƒë·ªãnh</b> ƒë·ªÉ nh√¢n v·∫≠t kh√¥ng b·ªã nh·∫ßm.
      B·∫°n c√≥ th·ªÉ d√πng prompt n√†y ƒë·ªÉ copy sang Midjourney/SD/ComfyUI/any model ho·∫∑c d√πng Gemini ƒë·ªÉ t·ª± m·ªü r·ªông n·ªôi dung.
    </p>
  </div>
  <div class="status">
    <span class="pill"><span class="dot" id="apiDot"></span> <span id="apiState">Ch∆∞a k·∫øt n·ªëi API</span></span>
    <span class="pill">‚å®Ô∏è <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> ƒë·ªÉ t·∫°o</span>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT: INPUT + SETTINGS -->
    <section class="card">
      <div class="hd">
        <b>1) Nh·∫≠p √Ω t∆∞·ªüng truy·ªán tranh</b>
        <span class="mini">M·∫πo: vi·∫øt 1‚Äì2 c√¢u l√† ƒë·ªß</span>
      </div>
      <div class="bd">
        <label>√ù t∆∞·ªüng / T√¨nh hu·ªëng ch√≠nh</label>
        <textarea id="idea" placeholder="V√≠ d·ª•: Doraemon cho Nobita m·ªôt b·∫£o b·ªëi ƒë·ªÉ l√†m b√†i nhanh, nh∆∞ng Shizuka v√¥ t√¨nh d√πng nh·∫ßm khi·∫øn c·∫£ l·ªõp b·ªã ƒë·∫£o l·ªôn."></textarea>

        <div class="row">
          <div>
            <label>S·ªë trang / s·ªë c·∫£nh (panel scenes)</label>
            <select id="panelCount">
              <option value="4">4 c·∫£nh (ng·∫Øn, d·ªÖ)</option>
              <option value="6" selected>6 c·∫£nh (chu·∫©n)</option>
              <option value="8">8 c·∫£nh (d√†i)</option>
            </select>
          </div>
          <div>
            <label>Gi·ªçng ƒëi·ªáu / kh√¥ng kh√≠</label>
            <select id="tone">
              <option value="h√†i h∆∞·ªõc, ·∫•m √°p, d·ªÖ th∆∞∆°ng" selected>H√†i h∆∞·ªõc ‚Äì ·∫•m √°p</option>
              <option value="k·ªãch t√≠nh nh·∫π, h·ªìi h·ªôp nh∆∞ng vui">H·ªìi h·ªôp ‚Äì vui</option>
              <option value="b√†i h·ªçc nh·∫π nh√†ng, c·∫£m ƒë·ªông">C·∫£m ƒë·ªông ‚Äì b√†i h·ªçc</option>
              <option value="ƒëi√™n r·ªì, phi l√Ω nh∆∞ng v·∫´n trong Doraemon">Phi l√Ω ‚Äì b√πng n·ªï</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ƒê·ªãa ƒëi·ªÉm ch√≠nh</label>
            <input id="place" type="text" placeholder="V√≠ d·ª•: l·ªõp h·ªçc, s√¢n ch∆°i, ph√≤ng Nobita" value="khu ph·ªë quen thu·ªôc, nh√† Nobita, l·ªõp h·ªçc" />
          </div>
          <div>
            <label>ƒê·ªô d√†i tho·∫°i (m·ªói b√≥ng tho·∫°i)</label>
            <select id="speechLen">
              <option value="ng·∫Øn, t·ªëi ƒëa 12 t·ª´/b√≥ng">Ng·∫Øn</option>
              <option value="v·ª´a, t·ªëi ƒëa 18 t·ª´/b√≥ng" selected>V·ª´a</option>
              <option value="d√†i, t·ªëi ƒëa 25 t·ª´/b√≥ng">D√†i</option>
            </select>
          </div>
        </div>

        <label>2) API Key Gemini (tu·ª≥ ch·ªçn ‚Äî n·∫øu mu·ªën ‚ÄúPrompt th√¥ng minh‚Äù)</label>
        <input id="apiKey" type="password" placeholder=" AIzaSyBmxXTrZy6WZJCt-Z2v9T_jIZdn_vRJkLo" />

        <div class="btns">
          <button id="btnQuick">‚ö° T·∫°o Prompt nhanh (kh√¥ng c·∫ßn API)</button>
          <button id="btnGemini" class="secondary">‚ú® T·∫°o Prompt th√¥ng minh (Gemini)</button>
          <button id="btnCopy" class="secondary">üìã Copy Prompt</button>
          <button id="btnReset" class="danger">üßπ Reset</button>
        </div>

        <p class="note">
          <b>Quan tr·ªçng:</b> ƒê√¢y l√† web tƒ©nh, API key n·∫±m ph√≠a client n√™n ch·ªâ d√πng cho c√° nh√¢n. N·∫øu mu·ªën public, h√£y chuy·ªÉn call API sang server.
        </p>
      </div>
    </section>

    <!-- RIGHT: CHARACTER BIBLE + OUTPUT -->
    <section class="card">
      <div class="hd">
        <b>Character Bible (c·ªë ƒë·ªãnh, ch·ªëng nh·∫ßm nh√¢n v·∫≠t)</b>
        <span class="mini">Ch·ªâ s·ª≠a 1 l·∫ßn</span>
      </div>
      <div class="bd">
        <label>‚ÄúT·ªáp nh√¢n v·∫≠t‚Äù (ƒë·ª´ng xo√° ‚Äî gi√∫p model kh√¥ng nh·∫ßm)</label>
        <textarea id="bible"></textarea>

        <label>Prompt xu·∫•t ra (copy d√πng lu√¥n)</label>
        <div class="out" id="output"></div>

        <p class="note">
          Prompt n√†y ƒë√£ c√≥: <b>phong c√°ch m√†u, n√©t v·∫Ω, b·ªë c·ª•c panel, tho·∫°i ti·∫øng Vi·ªát, nh·∫•t qu√°n nh√¢n v·∫≠t</b>.
        </p>
      </div>
    </section>

  </div>
</main>

<script>
/**
 * =============================
 *  Doraemon Comic Prompt Helper
 *  - Single-file static site
 *  - Optional Gemini call
 * =============================
 */

// === 1) Default Character Bible (Fixed) ===
const DEFAULT_BIBLE = `
[CHARACTER_BIBLE_DORAEMON_FIXED]
- Doraemon: m√®o m√°y m√†u xanh, kh√¥ng tai, m·∫∑t tr√≤n, m≈©i ƒë·ªè, chu√¥ng v√†ng ·ªü c·ªï, t√∫i th·∫ßn k·ª≥ tr∆∞·ªõc b·ª•ng. T√≠nh c√°ch: th√¥ng minh, t·ªët b·ª•ng, ƒë√¥i khi ho·∫£ng nh∆∞ng lu√¥n gi√∫p b·∫°n.
- Nobita: c·∫≠u b√© t√≥c ƒëen, ƒëeo k√≠nh tr√≤n, √°o v√†ng, qu·∫ßn xanh, t√≠nh v·ª•ng v·ªÅ, hay l∆∞·ªùi, d·ªÖ ho·∫£ng, nh∆∞ng t·ªët b·ª•ng.
- Shizuka: b√© g√°i t√≥c ƒëen, hi·ªÅn, l·ªãch s·ª±, √°o h·ªìng, v√°y/ƒë·∫ßm s√°ng m√†u, chƒÉm h·ªçc, d·ªãu d√†ng.
- Gian (Jaian): c·∫≠u b√© to con, √°o cam, gi·ªçng l·ªõn, hay b·∫Øt n·∫°t, nh∆∞ng ƒë√¥i khi nghƒ©a kh√≠.
- Suneo: c·∫≠u b√© t√≥c nh·ªçn, √°o xanh l√°, th√≠ch khoe khoang, t√≠nh kh√¥n l·ªèi.
- B·ªëi c·∫£nh: khu ph·ªë Nh·∫≠t B·∫£n quen thu·ªôc, nh√† Nobita, c√¥ng vi√™n, l·ªõp h·ªçc. Th·ªùi gian hi·ªán ƒë·∫°i, √°nh s√°ng t∆∞∆°i.
RULES:
1) Kh√¥ng ƒë·ªïi m√†u qu·∫ßn √°o, ngo·∫°i h√¨nh, ph·ª• ki·ªán c·ªßa nh√¢n v·∫≠t.
2) Kh√¥ng th√™m nh√¢n v·∫≠t l·∫° tr·ª´ khi ƒë∆∞·ª£c y√™u c·∫ßu.
3) Khi m√¥ t·∫£ c·∫£nh, lu√¥n gi·ªØ t·ª∑ l·ªá Doraemon th·∫•p h∆°n Nobita m·ªôt ch√∫t, ƒë·ª©ng c·∫°nh/ƒëi sau.
4) ƒê·ªëi tho·∫°i ti·∫øng Vi·ªát, gi·ªçng ƒë√∫ng t√≠nh c√°ch t·ª´ng nh√¢n v·∫≠t.
[/CHARACTER_BIBLE_DORAEMON_FIXED]
`.trim();

// === 2) Local storage helpers ===
const LS_KEY = "doraemon_prompt_helper_v1";
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
    return s;
  }catch(e){ return {}; }
}
function saveState(partial){
  const prev = loadState();
  localStorage.setItem(LS_KEY, JSON.stringify({ ...prev, ...partial }));
}

// === 3) DOM ===
const ideaEl = document.getElementById("idea");
const panelCountEl = document.getElementById("panelCount");
const toneEl = document.getElementById("tone");
const placeEl = document.getElementById("place");
const speechLenEl = document.getElementById("speechLen");
const apiKeyEl = document.getElementById("apiKey");
const bibleEl = document.getElementById("bible");
const outputEl = document.getElementById("output");

const apiDot = document.getElementById("apiDot");
const apiState = document.getElementById("apiState");

const btnQuick = document.getElementById("btnQuick");
const btnGemini = document.getElementById("btnGemini");
const btnCopy = document.getElementById("btnCopy");
const btnReset = document.getElementById("btnReset");

// === 4) Init ===
(function init(){
  const state = loadState();
  bibleEl.value = state.bible || DEFAULT_BIBLE;
  apiKeyEl.value = state.apiKey || "";
  ideaEl.value = state.idea || "";
  panelCountEl.value = state.panelCount || "6";
  toneEl.value = state.tone || "h√†i h∆∞·ªõc, ·∫•m √°p, d·ªÖ th∆∞∆°ng";
  placeEl.value = state.place || "khu ph·ªë quen thu·ªôc, nh√† Nobita, l·ªõp h·ªçc";
  speechLenEl.value = state.speechLen || "v·ª´a, t·ªëi ƒëa 18 t·ª´/b√≥ng";
  outputEl.textContent = state.output || "üëâ Nh·∫≠p √Ω t∆∞·ªüng v√† b·∫•m ‚ÄúT·∫°o Prompt‚Äù.";
  updateApiState();

  // Autosave changes
  [bibleEl, apiKeyEl, ideaEl, panelCountEl, toneEl, placeEl, speechLenEl].forEach(el=>{
    el.addEventListener("input", () => {
      saveState({
        bible: bibleEl.value,
        apiKey: apiKeyEl.value,
        idea: ideaEl.value,
        panelCount: panelCountEl.value,
        tone: toneEl.value,
        place: placeEl.value,
        speechLen: speechLenEl.value,
      });
      updateApiState();
    });
  });
})();

function updateApiState(){
  const hasKey = (apiKeyEl.value || "").trim().length > 10;
  apiDot.className = "dot " + (hasKey ? "ok" : "");
  apiState.textContent = hasKey ? "S·∫µn s√†ng d√πng Gemini" : "Ch∆∞a c√≥ API key";
}

// === 5) Prompt builder (Quick mode) ===
function buildPromptQuick(){
  const idea = ideaEl.value.trim();
  if(!idea){
    outputEl.textContent = "‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p √Ω t∆∞·ªüng.";
    return;
  }

  const bible = bibleEl.value.trim();
  const panels = panelCountEl.value;
  const tone = toneEl.value;
  const place = placeEl.value.trim();
  const speechLen = speechLenEl.value;

  const prompt =
`[PROMPT_TAO_TRUYEN_TRANH_DORAEMON_TIENg_VIET]
M·ª§C TI√äU:
- T·∫°o truy·ªán tranh Doraemon theo phong c√°ch manga thi·∫øu nhi Nh·∫≠t B·∫£n c·ªï ƒëi·ªÉn, m√†u s·∫Øc t∆∞∆°i s√°ng, n√©t s·∫°ch, d·ªÖ th∆∞∆°ng, kh√¥ng b·∫°o l·ª±c n·∫∑ng.
- Ng√¥n ng·ªØ tho·∫°i: ti·∫øng Vi·ªát, t·ª± nhi√™n, ƒë√∫ng t√≠nh c√°ch.
- Gi·ªØ nh·∫•t qu√°n nh√¢n v·∫≠t theo Character Bible.

${bible}

√ù T∆Ø·ªûNG:
"${idea}"

Y√äU C·∫¶U ƒê·∫¶U RA:
1) Vi·∫øt k·ªãch b·∫£n truy·ªán tranh g·ªìm ${panels} c·∫£nh (panel scenes).
2) M·ªói c·∫£nh ph·∫£i c√≥:
   - [C·∫¢NH #]: m√¥ t·∫£ b·ªë c·ª•c (to√†n c·∫£nh/c·∫≠n c·∫£nh), v·ªã tr√≠ nh√¢n v·∫≠t, h√†nh ƒë·ªông, c·∫£m x√∫c.
   - [M√ÄU & PHONG C√ÅCH]: m√†u t∆∞∆°i s√°ng, √°nh s√°ng ban ng√†y ho·∫∑c ph√π h·ª£p t√¨nh hu·ªëng, background r√µ, vibe Doraemon.
   - [THO·∫†I]: b√≥ng tho·∫°i ti·∫øng Vi·ªát (${speechLen}), ghi r√µ ai n√≥i.
3) B·ªëi c·∫£nh ch√≠nh: ${place}
4) Nh·ªãp truy·ªán: ${tone}
5) K·∫øt th√∫c: c√≥ twist h√†i h∆∞·ªõc + b√†i h·ªçc nh·∫π nh√†ng.

R√ÄNG BU·ªòC CH·ªêNG NH·∫¶M:
- Kh√¥ng ƒë·ªïi ngo·∫°i h√¨nh/ƒë·ªì/gi·ªçng nh√¢n v·∫≠t.
- Doraemon lu√¥n c√≥ t√∫i th·∫ßn k·ª≥ v√† chu√¥ng v√†ng.
- Nobita lu√¥n ƒëeo k√≠nh tr√≤n, √°o v√†ng, qu·∫ßn xanh.
- N·∫øu xu·∫•t hi·ªán b·∫£o b·ªëi: m√¥ t·∫£ r√µ h√¨nh d·∫°ng, c√°ch ho·∫°t ƒë·ªông, v√† h·∫≠u qu·∫£ h√†i.

ƒê·ªäNH D·∫†NG TR·∫¢ V·ªÄ:
Xu·∫•t theo m·∫´u:
C·∫¢NH 1:
- M√¥ t·∫£:
- M√†u & phong c√°ch:
- Tho·∫°i:
...
C·∫¢NH ${panels}:
- M√¥ t·∫£:
- M√†u & phong c√°ch:
- Tho·∫°i:
[/PROMPT_TAO_TRUYEN_TRANH_DORAEMON_TIENg_VIET]`;

  outputEl.textContent = prompt;
  saveState({ output: prompt });
}

// === 6) Gemini API call (Smart mode) ===
// NOTE: This is client-side, keep personal use only.
async function buildPromptGemini(){
  const apiKey = (apiKeyEl.value || "").trim();
  const idea = ideaEl.value.trim();
  if(!idea){
    outputEl.textContent = "‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p √Ω t∆∞·ªüng.";
    return;
  }
  if(apiKey.length < 10){
    outputEl.textContent = "‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p API Key Gemini (ho·∫∑c key qu√° ng·∫Øn).";
    return;
  }

  const bible = bibleEl.value.trim();
  const panels = panelCountEl.value;
  const tone = toneEl.value;
  const place = placeEl.value.trim();
  const speechLen = speechLenEl.value;

  outputEl.textContent = "‚è≥ ƒêang g·ªçi Gemini ƒë·ªÉ t·∫°o prompt th√¥ng minh...";

  // Gemini request prompt: ask Gemini to return a ready-to-copy prompt
  const systemInstruction =
`B·∫°n l√† tr·ª£ l√Ω t·∫°o PROMPT truy·ªán tranh Doraemon b·∫±ng ti·∫øng Vi·ªát.
Nhi·ªám v·ª•: T·ª´ √Ω t∆∞·ªüng ng∆∞·ªùi d√πng, t·∫°o ra m·ªôt prompt cu·ªëi c√πng ƒë·ªÉ h·ªç copy d√πng cho AI t·∫°o truy·ªán tranh.
Prompt cu·ªëi c√πng ph·∫£i gi·ªØ Character Bible c·ªë ƒë·ªãnh ƒë·ªÉ tr√°nh nh·∫ßm nh√¢n v·∫≠t.
Kh√¥ng vi·∫øt truy·ªán, ch·ªâ vi·∫øt PROMPT.`;

  const userMessage =
`H√£y t·∫°o PROMPT copy d√πng ngay theo y√™u c·∫ßu sau:

- S·ªë c·∫£nh: ${panels}
- Nh·ªãp truy·ªán: ${tone}
- B·ªëi c·∫£nh: ${place}
- ƒê·ªô d√†i tho·∫°i: ${speechLen}
- √ù t∆∞·ªüng: "${idea}"

ƒê√¢y l√† Character Bible b·∫Øt bu·ªôc:
${bible}

Y√™u c·∫ßu:
1) Prompt cu·ªëi c√πng c√≥ c·∫•u tr√∫c r√µ r√†ng, ng·∫Øn g·ªçn nh∆∞ng ƒë·ªß chi ti·∫øt.
2) Nh·∫•n m·∫°nh phong c√°ch m√†u, n√©t v·∫Ω, v√† ch·ªëng nh·∫ßm nh√¢n v·∫≠t.
3) Nh·∫Øc r√µ: tho·∫°i ti·∫øng Vi·ªát.
4) ƒê∆∞a ra ƒë·ªãnh d·∫°ng output theo d·∫°ng t·ª´ng c·∫£nh.
Ch·ªâ xu·∫•t ra prompt, kh√¥ng gi·∫£i th√≠ch th√™m.`;

  // Using Gemini 1.5 Flash style endpoint
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(apiKey)}`;

  const body = {
    contents: [
      { role: "user", parts: [{ text: systemInstruction + "\n\n" + userMessage }] }
    ],
    generationConfig: {
      temperature: 0.7,
      topP: 0.9,
      maxOutputTokens: 2048
    }
  };

  try{
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if(!res.ok){
      const t = await res.text();
      outputEl.textContent = `‚ùå L·ªói API: ${res.status}\n\n${t}`;
      return;
    }

    const data = await res.json();
    const text = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join("") || "";

    if(!text){
      outputEl.textContent = "‚ùå Gemini tr·∫£ v·ªÅ r·ªóng. H√£y th·ª≠ l·∫°i.";
      return;
    }

    outputEl.textContent = text.trim();
    saveState({ output: text.trim() });

  }catch(err){
    outputEl.textContent = `‚ùå Kh√¥ng th·ªÉ g·ªçi API (CORS / m·∫°ng). L·ªói:\n${err.message}`;
  }
}

// === 7) Copy ===
async function copyOutput(){
  const text = outputEl.textContent || "";
  if(!text.trim()){
    alert("Ch∆∞a c√≥ prompt ƒë·ªÉ copy.");
    return;
  }
  try{
    await navigator.clipboard.writeText(text);
    alert("‚úÖ ƒê√£ copy prompt v√†o clipboard!");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    alert("‚úÖ ƒê√£ copy (fallback)!");
  }
}

// === 8) Reset ===
function resetAll(){
  if(!confirm("Reset to√†n b·ªô n·ªôi dung? (s·∫Ω xo√° l∆∞u localStorage)")) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

// === 9) Events ===
btnQuick.addEventListener("click", buildPromptQuick);
btnGemini.addEventListener("click", buildPromptGemini);
btnCopy.addEventListener("click", copyOutput);
btnReset.addEventListener("click", resetAll);

// Ctrl + Enter to generate quick prompt
document.addEventListener("keydown", (e)=>{
  if(e.ctrlKey && e.key === "Enter"){
    buildPromptQuick();
  }
});
</script>
</body>
</html>
